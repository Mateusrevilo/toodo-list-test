name: Pipeline CI/CD
on:
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "app/**"
      - "components/**"
      - ".github/workflows/**"
jobs:
  # Primeiro Job: "build" (alterado o nome para ser mais claro e usado na dependência)
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout do código
        uses: actions/checkout@v5 # Este uses: precisa estar alinhado com o - name:

      - name: Instalação do Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Instalação das Dependências # Corrigido "Depêndecias"
        run: npm install

      - name: Rodar o build
        run: npm run build

  # Segundo Job: "tests" (agora no mesmo nível de indentação que "build")
  tests:
    runs-on: ubuntu-latest
    needs: build # needs deve estar no mesmo nível que runs-on

    steps: # steps deve estar no mesmo nível que runs-on
      - name: Checkout do código
        uses: actions/checkout@v5

      - name: Instalação do Node
        uses: actions/setup-node@v4

        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Instalação das Dependências
        run: npm install

      - name: Rodar o lint
        run: npm run lint

      - name: Rodar testes
        run: npm run test


  deploy: 
    runs-on: ubuntu-latest
    needs: tests

    steps:
      - name: Checkout do código
        uses: actions/checkout@v5

      - name: Instalação do Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: package-lock.json

      - name: Instalar Vercel CLI
        run: npm install -g vercel@latest

      - name: Vincular projeto Vercel
        id: vercel-link
        continue-on-error: true
        run: |
          # Se VERCEL_PROJECT_ID estiver configurado, tenta vincular o projeto
          if [ -n "$VERCEL_PROJECT_ID" ] && [ -n "$VERCEL_ORG_ID" ]; then
            echo "Vinculando projeto existente: $VERCEL_PROJECT_ID"
            vercel link --yes --token=$VERCEL_TOKEN --project=$VERCEL_PROJECT_ID --scope=$VERCEL_ORG_ID && {
              echo "linked=true" >> $GITHUB_OUTPUT
              echo "✅ Projeto vinculado com sucesso"
            } || {
              echo "linked=false" >> $GITHUB_OUTPUT
              echo "⚠️ Não foi possível vincular o projeto. Será criado um novo projeto no deploy."
            }
          else
            echo "linked=false" >> $GITHUB_OUTPUT
            echo "VERCEL_PROJECT_ID não configurado. Projeto será criado automaticamente no deploy."
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy pra Vercel (projeto vinculado)
        if: steps.vercel-link.outputs.linked == 'true'
        run: vercel deploy --prod --yes --token=$VERCEL_TOKEN
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

      - name: Deploy pra Vercel (novo projeto)
        if: steps.vercel-link.outputs.linked != 'true'
        run: vercel deploy --prod --yes --token=$VERCEL_TOKEN
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
       
